name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.goos }}-${{ matrix.goarch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux 平台
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          # macOS 平台（交叉编译）
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          # Windows 平台（交叉编译）
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
          # FreeBSD 平台（交叉编译）
          - goos: freebsd
            goarch: amd64
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Extract version
        id: version
        shell: bash
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Build binary
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          # 设置文件扩展名
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi

          # 设置二进制文件名
          BINARY_NAME="llm-memory-${GOOS}-${GOARCH}${EXT}"

          # 纯 Go 编译（无需 CGO）
          export CGO_ENABLED=0

          # 构建二进制
          go build \
            -trimpath \
            -ldflags="-X 'github.com/XiaoLFeng/llm-memory/cmd.Version=${VERSION}' -s -w" \
            -o "$BINARY_NAME"

          echo "Built: $BINARY_NAME"
          ls -lh "$BINARY_NAME"

      - name: Generate checksum
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          # 设置文件扩展名
          EXT=""
          if [ "$GOOS" = "windows" ]; then
            EXT=".exe"
          fi

          BINARY_NAME="llm-memory-${GOOS}-${GOARCH}${EXT}"

          # 生成 SHA256 校验和
          sha256sum "$BINARY_NAME" > "checksum-${GOOS}-${GOARCH}.txt"

          echo "Checksum generated:"
          cat "checksum-${GOOS}-${GOARCH}.txt"

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.goos }}-${{ matrix.goarch }}
          path: llm-memory-*
          if-no-files-found: error

      - name: Upload checksum artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksum-${{ matrix.goos }}-${{ matrix.goarch }}
          path: checksum-*.txt
          if-no-files-found: error

  checksum:
    name: Generate checksums file
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download all checksum artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: checksum-*
          merge-multiple: true

      - name: Merge checksums
        run: |
          # 合并所有校验和文件
          cat checksum-*.txt | sort > checksums.txt

          echo "=== checksums.txt content ==="
          cat checksums.txt
          echo "============================="

      - name: Upload checksums artifact
        uses: actions/upload-artifact@v4
        with:
          name: checksums
          path: checksums.txt
          if-no-files-found: error

  upload:
    name: Upload release assets
    needs: [build, checksum]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (for scripts)
        uses: actions/checkout@v4

      - name: Download all binary artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: binary-*
          merge-multiple: true

      - name: Download checksums
        uses: actions/download-artifact@v4
        with:
          name: checksums

      - name: List all files
        run: |
          echo "=== Files to upload ==="
          ls -lh
          echo "======================="

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            llm-memory-*
            checksums.txt
            scripts/install.sh
            scripts/install.ps1
            scripts/uninstall.sh
            scripts/uninstall.ps1
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-homebrew:
    name: Update Homebrew Formula
    needs: upload
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # 生成类名后缀（去掉点，如 0.0.4 → 004）
          CLASS_SUFFIX=$(echo "$VERSION" | tr -d '.')
          echo "class_suffix=$CLASS_SUFFIX" >> $GITHUB_OUTPUT
          echo "Updating Homebrew Formula to version: $VERSION"

      - name: Checkout homebrew-tap repository
        uses: actions/checkout@v4
        with:
          repository: XiaoLFeng/homebrew-tap
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Get old version
        id: old_version
        working-directory: homebrew-tap
        run: |
          OLD_VERSION=$(grep -oP 'version "\K[0-9]+\.[0-9]+\.[0-9]+' Formula/l/llm-memory.rb)
          echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
          OLD_CLASS_SUFFIX=$(echo "$OLD_VERSION" | tr -d '.')
          echo "old_class_suffix=$OLD_CLASS_SUFFIX" >> $GITHUB_OUTPUT
          echo "Current version in Formula: $OLD_VERSION"

      - name: Create versioned Formula for old version
        working-directory: homebrew-tap
        env:
          OLD_VERSION: ${{ steps.old_version.outputs.old_version }}
          OLD_CLASS_SUFFIX: ${{ steps.old_version.outputs.old_class_suffix }}
        run: |
          VERSIONED_FILE="Formula/l/llm-memory@${OLD_VERSION}.rb"

          if [ -f "$VERSIONED_FILE" ]; then
            echo "Versioned Formula already exists: $VERSIONED_FILE"
            exit 0
          fi

          echo "Creating versioned Formula: $VERSIONED_FILE"

          # 复制主 Formula
          cp Formula/l/llm-memory.rb "$VERSIONED_FILE"

          # 修改文件头注释
          sed -i "s/# Formula for llm-memory/# Formula for llm-memory@${OLD_VERSION}/" "$VERSIONED_FILE"
          sed -i "s/LLM统一记忆系统$/LLM统一记忆系统（固定版本）/" "$VERSIONED_FILE"

          # 修改类名: LlmMemory → LlmMemoryATXXX
          sed -i "s/class LlmMemory < Formula/class LlmMemoryAT${OLD_CLASS_SUFFIX} < Formula/" "$VERSIONED_FILE"

          # 修改 caveats 中的提示
          sed -i "s/llm-memory 已成功安装/llm-memory@${OLD_VERSION} 已成功安装/" "$VERSIONED_FILE"

          # 在 caveats 中添加固定版本警告（在 "快速开始" 前）
          sed -i '/快速开始/i\      ⚠️  注意：这是一个固定版本的 Formula\n      - 此版本不会自动更新到更高版本\n      - 如需最新版本，请使用：brew install llm-memory\n' "$VERSIONED_FILE"

          echo "Created versioned Formula: $VERSIONED_FILE"

      - name: Update main Formula version
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          FORMULA_FILE="Formula/l/llm-memory.rb"

          echo "Updating version to: $VERSION"
          sed -i 's/^  version "[0-9]*\.[0-9]*\.[0-9]*"/  version "'"$VERSION"'"/' "$FORMULA_FILE"

          echo "Updated Formula version:"
          grep "version" "$FORMULA_FILE"

      - name: Commit and push changes
        working-directory: homebrew-tap
        env:
          VERSION: ${{ steps.version.outputs.version }}
          OLD_VERSION: ${{ steps.old_version.outputs.old_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # 检查是否有变更
          if git diff --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "No changes to commit (version might already be up to date)"
            exit 0
          fi

          git add Formula/l/

          # 判断是否创建了版本化 Formula
          if [ -f "Formula/l/llm-memory@${OLD_VERSION}.rb" ] && git diff --cached --name-only | grep -q "llm-memory@"; then
            git commit -m "chore(llm-memory): bump to v${VERSION}, archive v${OLD_VERSION}

          - Update llm-memory.rb to version ${VERSION}
          - Create llm-memory@${OLD_VERSION}.rb for version pinning

          Automated update from llm-memory release workflow.
          Release: https://github.com/XiaoLFeng/llm-memory/releases/tag/v${VERSION}"
          else
            git commit -m "chore(llm-memory): bump version to ${VERSION}

          Automated update from llm-memory release workflow.
          Release: https://github.com/XiaoLFeng/llm-memory/releases/tag/v${VERSION}"
          fi

          git push origin master
          echo "✅ Successfully updated homebrew-tap!"
